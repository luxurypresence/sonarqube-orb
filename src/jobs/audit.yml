description: >
  Job runs OWASP Dependency Check and SonarQube scanner. Results are send to SonarQube web app

executor: default

parameters:
  sonarqube_settings_path:
    type: string
    description: "Path to file with sonarqube settings"
  dependency_check_project_name:
    type: string
    description: "Name used by OWASP Dependency Check"

steps:
  - checkout
  - attach_workspace:
      at: .
  - run:
      name: Run OWASP Dependency Check
      command: |
        docker run --name owasp-dependency-check --volume $(pwd):/src owasp/dependency-check:6.1.5 --scan /src --format "ALL" --project "<< parameters.dependency_check_project_name >>"  --out /report --disableNodeAuditCache --disableOssIndexCache --disableCentralCache
        docker cp owasp-dependency-check:/report odc-reports
  - run:
      name: Install Sonarqube scanner
      command: |
        wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-<< parameters.version >>.zip
        unzip sonar-scanner-cli-4.5.0.2216-linux.zip
  - run:
      # it will ignore if there is an error runnign the scanner
      name: Run Sonarqube scanner
      command: |
        ./sonar-scanner-4.5.0.2216-linux/bin/sonar-scanner -Dproject.settings=<< parameters.sonarqube_settings_path >> || true
