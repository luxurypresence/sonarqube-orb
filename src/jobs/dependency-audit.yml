description: >
  Job runs OWASP Dependency Check

executor: default

parameters:
  dependency_check_project_name:
    type: string
    description: "Name used by OWASP Dependency Check"

steps:
  - checkout
  - attach_workspace:
      at: .
  - run:
      name: Create file with current year and weak information - needed for cache
      command: echo "$(date +%U)-$(date +%Y)" > current_weak_information.txt
  - restore_cache:
      keys:
#        TODO Remove dev2 from key
        - dependency-check-data-dev2-{{ checksum "current_weak_information.txt" }}
        - dependency-check-data-dev2-
  - run:
      name: Creates + Copy OWASP Cache Into Docker Volume
      command: |
        docker volume create dependency-audit-data-volume
        docker run -v dependency-audit-data-volume:/data --name copy-data-helper busybox true
        mkdir -p dependency-audit-data
        docker cp dependency-audit-data/. copy-data-helper:/data
        docker rm copy-data-helper
        rm -rf dependency-audit-data
  - run:
      name: Run OWASP Dependency Check
      command: |
        docker run --name owasp-dependency-check \
          -e user=$USER \
          -u $(id -u ${USER}):$(id -g ${USER}) \
          --volume dependency-audit-data-volume:/usr/share/dependency-check/data:z \
          --volume $(pwd):/src:z \
          owasp/dependency-check:6.1.6 \
          --scan /src --format "ALL" --project "<< parameters.dependency_check_project_name >>"  --out /report
        docker cp owasp-dependency-check:/report odc-reports
        docker cp owasp-dependency-check:/usr/share/dependency-check/data dependency-audit-data
  - save_cache:
      paths:
        - dependency-audit-data
      key: dependency-check-data-dev2-{{ checksum "current_weak_information.txt" }}
  - persist_to_workspace:
      root: .
      paths:
        - odc-reports
