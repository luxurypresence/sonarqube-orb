description: >
  Job runs OWASP Dependency Check

executor: java

parameters:
  dependency_check_project_name:
    type: string
    description: "Name used by OWASP Dependency Check"

steps:
  - checkout
  - attach_workspace:
      at: .
  - run:
      name: Create file with current year and weak information - needed for cache
      command: echo "$(date +%U)-$(date +%Y)" > current_weak_information.txt
  #  - restore_cache:
  #      keys:
  ##        TODO Remove dev2 from key
  #        - dependency-check-data-dev2-{{ checksum "current_weak_information.txt" }}
  #        - dependency-check-data-dev2-
  - run:
      name: Install yarn
      command: |
        sudo mkdir /opt/yarn
        curl -Ls https://yarnpkg.com/latest.tar.gz | sudo tar -xz --strip-components=1 --directory /opt/yarn
        sudo ln -s /opt/yarn/bin/yarn /usr/bin/yarn
        yarn --version
  - run:
      name: Download OWASP Dependency Check + Unzip
      command: |
        wget https://github.com/jeremylong/DependencyCheck/releases/download/v6.1.6/dependency-check-6.1.6-release.zip
        unzip dependency-check-6.1.6-release.zip
  - run:
      name: Run OWASP Dependency Check
      command: |
        ./dependency-check/bin/dependency-check.sh --scan $(pwd) --format "ALL" --project "<< parameters.dependency_check_project_name >>"  --out $(pwd)/odc-reports
        ls
        ls odc-reports
        ls /usr/share/dependency-check/data
#  - save_cache:
#      paths:
#        - dependency-audit-data
#      key: dependency-check-data-dev2-{{ checksum "current_weak_information.txt" }}
#  - persist_to_workspace:
#      root: .
#      paths:
#        - odc-reports
